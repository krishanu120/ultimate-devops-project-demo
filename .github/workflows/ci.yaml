#CI for product catalog service
name: product-catalog-ci

on:
    pull_request:
        branches:
          - main

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
         - name: checkout code
           uses: action/checkout@v4

         - name: setup Go 1.22
           uses: action/setup-go@v2
           with:
            go-version: 1.22

         - name: Build
           run: |
            cd src/product-catalog
            go mod download
            go build -o product-catalog-service main.go


         -  name: unit tests
            run: go test src/product-catalog/...

    code-quality:
        runs-on: ubuntu-latest


        steps:
          - name: checkout code
            uses: action/checkout@v4

          - name: Run golangci--lint
            run: |
                  go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.56.2
                  golangci-lint run src/product-catalog/...

                
    docker:
        runs-on: ubuntu-latest

        needs: build

        steps:
         - name: checkout code
           uses: action/checkout@v4

         - name: Install Docker
           uses: Docker/setup-buildx-action@v1
           
         - name: login to Docker
           uses: docker/login-action@v3

           with:
             username: ${{ secrets.DOCKER_USERNAME }}
             password: ${{ secrets.DOCKER_TOKEN}}
       
         - name: Docker push
           uses: docker/build-path-action@v6
           with:
              context: src/product-catalog
              file: Dockerfile
              push: true
              tags: ${{ secrets.DOCKER_USERNAME }}/product-catalog-service${{github.run_id}}

        
       updatek8s:
            runs-on: ubuntu-latest
            
            needs: docker

            steps:
              - name: checkout code
                uses: action/checkout@v4
                with:
                   token: ${{ secrets.GITHUB_TOKEN }}

              - name: Update tag in kubernets deployment manifest
                run: |
                    sed -i 's/image: .*/image: ${{ secrets.DOCKER_USERNAME }}/product-catalog: "${{github.run_id}}"/' kubernetes/producatcatalog/deploy/deployment.yaml

              - name: Commit and push changes
                run: |
                 git config --global user.email "krishanudas508@gmail.com"
                 git config --global user.name "Krishanu Das"
                 git add kubernetes/productcatalog/deploy.yaml
                 git commit -m "[CI]: Update product catalog image tag"
                 git push origin HEAD:main -f
      



      